import pytest

import pandas as pd
import numpy as np
from rapidfuzz import fuzz

from trialcurator.eligibility_text_preparation import llm_sanitise_text
from trialcurator.tests.external.test_llm_sanitise_text import remove_blank_lines_and_trailing_footstops
from trialcurator.gemini_client import GeminiClient
from trialcurator.openai_client import OpenaiClient


@pytest.fixture
def client():
    return GeminiClient()
    # return OpenaiClient()


NUM_TESTS = 10


def test_sanitisation_variability(client):
    # Entire eligibility criteria from NCT06644755
    input_text = '''
Key Inclusion Criteria:\n\n1. Sign and date the main ICF.\n2. Adults \u226518 years at the time the biosample ICF or main ICF, whichever is signed first.\n\n   Follow local regulatory requirements if the legal age of consent for trial participation is \\>18 years old.\n3. One of the following histologically or cytologically documented cancers:\n\n   Advanced (metastatic or unresectable) SS Advanced (metastatic or unresectable) MRCLS Metastatic or unresectable locally advanced NSCLC (Ad/Sq) Metastatic or unresectable locally advanced UC\n4. Relapsed from, refractory to, or intolerant to appropriate therapies \\[eg, standard of care (SOC) therapy\\] to provide clinical benefit for their condition as assessed by their physician and/or investigator. \\[For South Korea only: Relapsed from, refractory to, or intolerant to all available therapies (eg, SOC therapy domestically approved) for their condition.\\]\n5. HLA-A\\*02:01, 02:02, 02:03, 02:04, 02:05, 02:06, 02:09, 02:10, or 02:11 positive.\n6. Has measurable disease based on RECIST v1.1 on computed tomography/magnetic resonance imaging (CT/MRI).\n7. Is willing and able to provide adequate pre-treatment or archival tumor tissue sample.\n8. Has Eastern Cooperative Oncology Group Performance Status (ECOG PS) score of 0 or 1 at Screening.\n9. Meets the following required baseline local laboratory data within 14 days prior to start of trial intervention administration:\n\n   1. Alanine aminotransferase (ALT) and aspartate aminotransferase (AST) \u22643 \u00d7 upper limit of normal (ULN) in participants with no liver metastasis, or \u22645 \u00d7 ULN in participants with liver metastasis\n   2. Total bilirubin (TBL) \u22641.5 \u00d7 ULN (\u22643 \u00d7 ULN for participants with a documented history of Gilbert's syndrome)\n   3. Absolute neutrophil count (ANC) \u22651.5 \u00d7 10\\^9/L\n   4. Platelet count \u2265100 \u00d7 10\\^9/L\n   5. Hemoglobin \u22658 g/dL\n   6. Creatinine clearance (CrCl) \u226545 mL/min as calculated using the Cockcroft-Gault equation (Section 10.3.1)\n\n   Note: Any blood or blood product transfusion is allowed up to 7 days before the hematology evaluations and any dose of hematologic growth factor is allowed up to 14 days before the hematology evaluations.\n10. a) A female participant of childbearing potential (CBP), as defined in Section 10.3.5.1, is eligible to participate if the following conditions are met: Participant is not pregnant as confirmed by highly sensitive pregnancy test (see Section 10.3.5.3). Participant does not breastfeed during the trial intervention period and for at least 120 days after last dose of trial intervention. Participant agrees to adhere to a contraceptive method that is highly effective (Section 10.3.5.2) and agrees not to donate eggs (ova, oocytes) to others or freeze/store eggs during the intervention period and for at least the time needed to eliminate the trial intervention after the last dose. The length of time required to continue contraception after last dose for the trial intervention is 120 days. Preservation of eggs may be considered prior to first dose of trial intervention.\n\n    b) A male participant capable of producing sperm is eligible to participate if he agrees to the following during the Treatment Period and for at least the time needed to eliminate the trial intervention. The length of time required to continue contraception after the last dose of the trial intervention is 120 days.\n    * Avoid donating sperm. Note: Preservation of sperm should be considered prior to enrollment/randomization in this trial.\n    * Adhere to either of the following contraception methods:\n\n      * True abstinence from penile-vaginal intercourse, when this is in line with the preferred and usual lifestyle of the participant, OR\n      * Uses a penile/external condom when having penile-vaginal intercourse with a nonparticipant of childbearing potential (see Section 10.3.5) PLUS partner use of an additional contraceptive method (see Section 10.3.5.2), as a condom may break or leak. Contraceptive use should be consistent with local regulations regarding the methods of contraception for those participating in clinical studies. If the contraception requirements in the local label for any of the trial interventions are more stringent than the requirements above, the local label requirements are to be followed.\n\nNote: If the participant is azoospermic (vasectomized or secondary to medical cause, documented from the site personnel's review of the participant's medical records, medical examination, or medical history interview), no contraception is required.\n\nKey Exclusion Criteria:\n\n1. Has received prior therapy targeting NY-ESO-1.\n2. Has an inadequate treatment washout period prior to the start of trial intervention, defined as follows:\n\n   1. Radiation therapy: \\<4 weeks (or \\<2 weeks if palliative radiation therapy without abdominal/pelvic radiation)\n   2. Chemotherapy, antibody-based anticancer therapy, immunotherapy: \\<4 weeks\n   3. Small molecules (eg, tyrosine kinase inhibitors): \\<2 weeks or 5 half-lives, whichever is longer\n3. Has known symptomatic central nervous system (CNS) metastases, leptomeningeal disease, or cord compression. Note: Asymptomatic or adequately treated CNS metastases are not exclusionary provided that, in the opinion of the investigator, the participant is neurologically stable.\n\n   MRI/CT of the brain is required for all participants during Screening Period (see Section 8.3.1).\n4. Uncontrolled or clinically significant cardiovascular disease, including the following:\n\n   1. Myocardial infarction within 6 months prior to screening\n   2. Uncontrolled angina pectoris within 6 months prior to screening\n   3. New York Heart Association (NYHA) Class III or IV congestive heart failure\n   4. Left ventricular ejection fraction (LVEF) \u226450% or lower than the institutional lower limit of normal\n   5. QT interval corrected with Fridericia's formula (QTcF) interval \\>480 ms\n5. Chronic steroid treatment (IV or oral) or any other immunosuppressive medication (ie, prednisone \\>10 mg daily (QD) or the equivalent).\n6. Has active other primary malignancies. Note: Participants with the following can be enrolled: Adequately resected non-melanoma skin cancer, curatively treated in situ disease, superficial cancer in the gastrointestinal tract curatively resected by endoscopic surgery, or any other solid tumors curatively treated with no evidence of recurrent disease for \u22653 years and requires no treatment.\n7. Has unresolved toxicities from previous anticancer treatment, defined as toxicities (other than alopecia) not yet resolved to National Cancer Institute Common Terminology Criteria for Adverse Events (NCI-CTCAE) v5.0, Grade \u22641 or baseline. Note: Participants with chronic, stable Grade 2 toxicities (defined as no worsening for 1 month prior to enrollment and managed with SOC treatment) that the investigator deems related to previous anticancer treatment may be enrolled. Such toxicities may include the following:\n\n   1. Chemotherapy-induced peripheral neuropathy\n   2. Residual toxicities from prior immuno-oncology treatment:\n\n   Grade 2 endocrinopathies (hypothyroidism, hyperthyroidism, adrenal insufficiency, hyperglycemia due to type 1 diabetes mellitus) with adequate therapy Grade 2 skin hypopigmentation (vitiligo)\n8. Has known hypersensitivity to biological agents.\n9. Has a history of or active autoimmune disease.\n\n   Note: Participants with the following examples may be enrolled as an exception:\n   1. Type I diabetes mellitus/hypothyroidism only requires hormone replacement.\n   2. Skin disorders (such as vitiligo, psoriasis, or alopecia) not requiring systemic treatment.\n10. Has human immunodeficiency virus (HIV) infection. Participants must be tested for HIV viral load during the Screening Period if acceptable by local regulations or Institutional Review Boards/Independent Ethics Committees (IRBs/IECs).\n\n    Note: For Part 2 only, the following participants will be eligible:\n    1. Have CD4+ T-cell count \u2265350 cells/mm3 at the time of screening.\n    2. Have virologic suppression, defined as confirmed HIV RNA level below 50 or the lower limit of quantitation (below the limit of detection) at the time of screening and for at least 12 weeks before screening.\n    3. Have no acquired immunodeficiency syndrome-defining opportunistic infections or conditions within the past 12 months.\n    4. Are on stable antiretroviral therapy regimen, without changes in drugs or dose modification, for at least 4 weeks before trial entry (Day 1) and agree to continue antiretroviral therapy throughout the trial, as defined per institutional protocol.\n11. Has active or uncontrolled hepatitis B or C infection as defined per institutional guidelines.\n\nNote: For Part 2 only, the following participants will be eligible:\n\n1. Hepatitis B surface antigen (HBsAg)-positive participants are eligible if they have received hepatitis B virus (HBV) antiviral therapy for at least 4 weeks and have undetectable HBV viral load prior to allocation (participants should remain on antiviral therapy throughout trial intervention and follow local guidelines for HBV antiviral therapy after completion of trial intervention).\n2. Have a history of hepatitis C infection and hepatitis C virus (HCV) viral load is below the level of detection in the absence of antiviral therapy during the previous 4 weeks.\n3. Have normal transaminase values, or, if liver metastases are present, abnormal transaminases with a result of AST/ALT \\<3 \u00d7 ULN, which are not attributable to HCV infection."
'''
    norm_levenshtein_matrix = np.zeros((NUM_TESTS, NUM_TESTS))
    outputs = []
    for _ in range(NUM_TESTS):
        output = remove_blank_lines_and_trailing_footstops(llm_sanitise_text(input_text, client))
        outputs.append(output)

    for i in range(NUM_TESTS):
        for j in range(NUM_TESTS):
            norm_levenshtein_matrix[i, j] = fuzz.ratio(outputs[i], outputs[j])  # The values on the diagonal is 100 by definition, but I want to calculate it explicitly to validate rapidfuzz

    assert np.allclose(norm_levenshtein_matrix, norm_levenshtein_matrix.transpose()) == True  # The matrix should be symmetric - if it is non-symmetric, then there is an error with rapidfuzz
    print(pd.DataFrame(norm_levenshtein_matrix))

    stats_mat = norm_levenshtein_matrix[np.triu_indices(NUM_TESTS, k=1)]  # Extract the upper triangular matrix & calculate summary stats on these values only
    print(pd.DataFrame(stats_mat.reshape(-1)).describe())
